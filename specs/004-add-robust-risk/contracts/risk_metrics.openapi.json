{
  "openapi": "3.0.3",
  "info": {
    "title": "Portfolio Risk Metrics API",
    "version": "0.1.0",
    "description": "Compute covariance, VaR, CVaR, and stress testing outputs for a portfolio."
  },
  "paths": {
    "/risk/report": {
      "post": {
        "summary": "Generate a complete risk report",
        "operationId": "createRiskReport",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "": "#/components/schemas/RiskReportRequest"
              }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Risk report accepted",
            "content": {
              "application/json": {
                "schema": {
                  "": "#/components/schemas/RiskReportResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/risk/reports/{report_id}": {
      "get": {
        "summary": "Fetch a previously generated risk report",
        "operationId": "getRiskReport",
        "parameters": [
          {
            "name": "report_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Risk report payload",
            "content": {
              "application/json": {
                "schema": {
                  "": "#/components/schemas/RiskReportResponse"
                }
              }
            }
          },
          "404": {
            "description": "Report not found",
            "content": {
              "application/json": {
                "schema": {
                  "": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/risk/scenarios": {
      "get": {
        "summary": "List available stress scenarios",
        "operationId": "listStressScenarios",
        "responses": {
          "200": {
            "description": "Available scenarios",
            "content": {
              "application/json": {
                "schema": {
                  "": "#/components/schemas/StressScenarioList"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "RiskReportRequest": {
        "type": "object",
        "required": [
          "portfolio_snapshot",
          "configuration"
        ],
        "properties": {
          "portfolio_snapshot": {
            "": "#/components/schemas/PortfolioSnapshot"
          },
          "configuration": {
            "": "#/components/schemas/RiskConfiguration"
          }
        }
      },
      "PortfolioSnapshot": {
        "type": "object",
        "required": [
          "asset_ids",
          "returns",
          "weights"
        ],
        "properties": {
          "asset_ids": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "returns": {
            "type": "array",
            "description": "Time-ordered rows of asset returns",
            "items": {
              "type": "array",
              "items": {
                "type": "number"
              }
            }
          },
          "timestamps": {
            "type": "array",
            "items": {
              "type": "string",
              "format": "date-time"
            }
          },
          "weights": {
            "type": "object",
            "additionalProperties": {
              "type": "number"
            }
          },
          "factor_exposures": {
            "type": "object",
            "additionalProperties": {
              "type": "number"
            },
            "description": "Optional factor loadings keyed by factor name"
          }
        }
      },
      "RiskConfiguration": {
        "type": "object",
        "required": [
          "confidence_levels",
          "horizons",
          "reports"
        ],
        "properties": {
          "confidence_levels": {
            "type": "array",
            "items": {
              "type": "number",
              "minimum": 0.9,
              "maximum": 0.999
            }
          },
          "horizons": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 1
            }
          },
          "decay_lambda": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0
          },
          "mc_paths": {
            "type": "integer",
            "minimum": 1000,
            "maximum": 100000
          },
          "seed": {
            "type": "integer"
          },
          "stress_scenarios": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "data_frequency": {
            "type": "string",
            "enum": [
              "daily",
              "weekly",
              "monthly"
            ]
          },
          "reports": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "covariance",
                "var",
                "cvar",
                "stress",
                "visualizations"
              ]
            }
          }
        }
      },
      "RiskReportResponse": {
        "type": "object",
        "required": [
          "report_id",
          "generated_at",
          "risk_metrics"
        ],
        "properties": {
          "report_id": {
            "type": "string"
          },
          "generated_at": {
            "type": "string",
            "format": "date-time"
          },
          "covariance_results": {
            "type": "array",
            "items": {
              "": "#/components/schemas/CovarianceResult"
            }
          },
          "risk_metrics": {
            "type": "array",
            "items": {
              "": "#/components/schemas/RiskMetricEntry"
            }
          },
          "stress_impacts": {
            "type": "array",
            "items": {
              "": "#/components/schemas/StressImpact"
            }
          },
          "visualizations": {
            "type": "array",
            "items": {
              "": "#/components/schemas/VisualizationArtifact"
            }
          }
        }
      },
      "CovarianceResult": {
        "type": "object",
        "required": [
          "method",
          "matrix"
        ],
        "properties": {
          "method": {
            "type": "string",
            "enum": [
              "sample",
              "ledoit_wolf",
              "ewma"
            ]
          },
          "matrix": {
            "type": "array",
            "items": {
              "type": "array",
              "items": {
                "type": "number"
              }
            }
          },
          "metadata": {
            "type": "object",
            "additionalProperties": {
              "type": [
                "string",
                "number",
                "integer",
                "boolean"
              ]
            }
          }
        }
      },
      "RiskMetricEntry": {
        "type": "object",
        "required": [
          "metric",
          "confidence",
          "horizon",
          "value",
          "method"
        ],
        "properties": {
          "metric": {
            "type": "string",
            "enum": [
              "var",
              "cvar"
            ]
          },
          "confidence": {
            "type": "number"
          },
          "horizon": {
            "type": "integer"
          },
          "value": {
            "type": "number",
            "minimum": 0
          },
          "method": {
            "type": "string",
            "enum": [
              "historical",
              "parametric",
              "monte_carlo"
            ]
          }
        }
      },
      "StressScenario": {
        "type": "object",
        "required": [
          "scenario_id",
          "name",
          "description",
          "shock_type",
          "parameters",
          "horizon"
        ],
        "properties": {
          "scenario_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "shock_type": {
            "type": "string",
            "enum": [
              "factor",
              "asset",
              "macro"
            ]
          },
          "parameters": {
            "type": "object",
            "additionalProperties": true
          },
          "horizon": {
            "type": "integer",
            "minimum": 1
          }
        }
      },
      "StressImpact": {
        "type": "object",
        "required": [
          "scenario_id",
          "expected_loss",
          "worst_case_loss"
        ],
        "properties": {
          "scenario_id": {
            "type": "string"
          },
          "expected_loss": {
            "type": "number",
            "minimum": 0
          },
          "worst_case_loss": {
            "type": "number",
            "minimum": 0
          },
          "factor_contributions": {
            "type": "object",
            "additionalProperties": {
              "type": "number"
            }
          },
          "notes": {
            "type": "string"
          }
        }
      },
      "VisualizationArtifact": {
        "type": "object",
        "required": [
          "artifact_id",
          "type",
          "path",
          "format"
        ],
        "properties": {
          "artifact_id": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "factor_exposure",
              "var_timeseries",
              "cvar_distribution",
              "stress_bar"
            ]
          },
          "path": {
            "type": "string",
            "description": "Absolute path to generated artifact"
          },
          "format": {
            "type": "string",
            "enum": [
              "png",
              "svg",
              "html"
            ]
          }
        }
      },
      "StressScenarioList": {
        "type": "object",
        "required": [
          "scenarios"
        ],
        "properties": {
          "scenarios": {
            "type": "array",
            "items": {
              "": "#/components/schemas/StressScenario"
            }
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": [
          "detail"
        ],
        "properties": {
          "detail": {
            "type": "string"
          },
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      }
    }
  }
}
